<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LUXIOU | æ™ºèƒ½ç—›ç‚¹ç­›æŸ¥çŸ©é˜µ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* é“‚é‡‘é«˜å®šé…è‰²ï¼šæ‹‰ä¸é‡‘(å®‰å…¨)ã€ç¥ç€æ©™(å…³æ³¨)ã€å‹ƒè‰®ç¬¬çº¢(å±é™©) */
        :root { --primary: #D4AF37; --warn: #FF8C00; --danger: #B22222; --bg: #050505; --surface: #121212; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; margin: 0; padding: 0; }
        
        body { background: var(--bg); color: #e2e8f0; font-family: "DIN Alternate", "Helvetica Neue", sans-serif; overflow-y: auto; -webkit-font-smoothing: antialiased; }
        #capture-area { background: var(--bg); width: 100%; min-height: 100vh; padding-bottom: 120px; display: block; }

        .header-brand { width: 100%; height: 60px; display: flex; align-items: center; justify-content: center; background: rgba(5, 5, 5, 0.95); border-bottom: 1px solid rgba(212, 175, 55, 0.15); position: relative; }
        .brand-text { font-size: 18px; font-weight: 900; color: var(--primary); letter-spacing: 2px; }
        .step-badge { position: absolute; right: 15px; background: rgba(212, 175, 55, 0.05); border: 1px solid var(--primary); color: var(--primary); font-size: 10px; padding: 4px 8px; border-radius: 12px; font-weight: bold; }

        .radar-section { width: 100%; height: 270px; display: flex; flex-direction: column; background: radial-gradient(circle at center, rgba(18, 18, 18, 0.8) 0%, var(--bg) 100%); border-bottom: 1px solid rgba(255,255,255,0.03); padding-top: 15px; }
        .score-board { display: flex; justify-content: space-between; align-items: flex-start; padding: 0 20px; z-index: 2; }
        .score-info { display: flex; flex-direction: column; }
        .risk-label { font-size: 11px; color: #888; font-weight: bold; letter-spacing: 1px; }
        .risk-score { font-size: 46px; font-weight: 900; color: var(--primary); text-shadow: 0 2px 5px rgba(0,0,0,0.9); line-height: 1; margin-top: 4px; transition: color 0.3s; }
        .risk-score.mod { color: var(--warn); }
        .risk-score.high { color: var(--danger); }
        
        .status-tag { font-size: 11px; font-weight: bold; padding: 6px 12px; border-radius: 6px; background: rgba(212, 175, 55, 0.05); color: var(--primary); border: 1px solid rgba(212, 175, 55, 0.3); transition: 0.3s; }
        .status-tag.warn { background: rgba(255, 140, 0, 0.05); color: var(--warn); border-color: rgba(255, 140, 0, 0.3); }
        .status-tag.crit { background: rgba(178, 34, 34, 0.05); color: var(--danger); border-color: rgba(178, 34, 34, 0.3); }

        .radar-container { position: relative; width: 100%; height: 200px; margin-top: 5px; }
        #radarCanvas { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; }

        .matrix-scroll { padding: 20px 15px; }
        .question-group { margin-bottom: 25px; }
        .q-title { font-size: 14px; font-weight: 900; color: #D1D5DB; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .q-title::before { content: ''; display: block; width: 3px; height: 14px; background: var(--primary); }
        
        .tags-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .tag-btn { background: var(--surface); border: 1px solid rgba(255,255,255,0.05); color: #888; padding: 12px 8px; border-radius: 8px; font-size: 13px; font-weight: bold; transition: all 0.2s; text-align: center; display: flex; align-items: center; justify-content: center; line-height: 1.3; cursor: pointer; }
        .tag-btn.active { background: rgba(212, 175, 55, 0.08); border-color: var(--primary); color: #fff; transform: scale(1.02); }
        .tag-btn.danger.active { background: rgba(178, 34, 34, 0.15); border-color: var(--danger); color: #fff; }
        .tag-btn.custom-add { border: 1px dashed #444; color: #888; background: transparent; grid-column: span 2; padding: 12px; }
        
        .signature-section { margin-top: 30px; padding: 20px 15px; background: var(--surface); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); }
        .sig-header { font-size: 12px; font-weight: bold; color: #888; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
        .contract-line { width: 100%; border-bottom: 1px solid #444; position: relative; height: 60px; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 5px; cursor: pointer; }
        .pulse-text { color: var(--primary); font-size: 16px; font-weight: bold; animation: pulse 2s infinite; }
        #sigResultImg { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); height: 80px; display: none; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        .bottom-action { position: fixed; bottom: 0; left: 0; width: 100%; padding: 15px 20px 25px 20px; background: linear-gradient(to top, rgba(5,5,5,1) 60%, rgba(5,5,5,0)); z-index: 10; }
        .btn-generate { width: 100%; background: linear-gradient(135deg, #D4AF37, #AA8A2A); color: #000; border: none; padding: 16px; border-radius: 12px; font-size: 16px; font-weight: 900; display: flex; justify-content: center; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.2); }

        /* ğŸš€ æš´åŠ›çš„å¼ºåˆ¶å”¤é†’å¼¹çª— */
        .input-modal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.9); z-index: 9999999; flex-direction: column; align-items: center; justify-content: center; }
        .input-box { background: #121212; width: 85%; max-width: 350px; padding: 25px; border-radius: 16px; border: 1px solid rgba(212, 175, 55, 0.3); }
        .input-title { color: #fff; font-size: 15px; font-weight: bold; margin-bottom: 20px; text-align: center; }
        .custom-input { width: 100%; padding: 16px; background: #050505; border: 1px solid #444; color: #fff; border-radius: 8px; font-size: 16px; margin-bottom: 25px; outline: none; -webkit-appearance: none; appearance: none; -webkit-user-select: text !important; user-select: text !important; pointer-events: auto !important; }
        .custom-input:focus { border-color: var(--primary); }
        .modal-btns { display: flex; gap: 15px; }
        .modal-btn { flex: 1; padding: 14px; border-radius: 8px; font-size: 15px; font-weight: bold; border: none; }
        .modal-btn.cancel { background: #222; color: #888; }
        .modal-btn.confirm { background: var(--primary); color: #000; }

        .sig-modal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #fff; z-index: 9999999; flex-direction: column; }
        .sig-modal-header { height: 70px; display: flex; align-items: center; justify-content: center; color: #000; font-weight: 900; font-size: 18px; border-bottom: 1px solid #ddd; background: #f8f9fa; letter-spacing: 2px;}
        #fullscreenSigCanvas { flex: 1; width: 100%; touch-action: none; background: #fff; }
        .sig-modal-footer { height: 90px; display: flex; gap: 15px; padding: 20px; background: #f8f9fa; border-top: 1px solid #eee; }
        .sig-btn { flex: 1; padding: 14px; border-radius: 8px; font-size: 16px; font-weight: bold; border: none; }
        .sig-btn.cancel { background: #e2e8f0; color: #475569; }
        .sig-btn.confirm { background: #000; color: #fff; }

        .poster-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 99999999; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .poster-scroll-area { max-height: 70vh; width: 100%; overflow-y: auto; border-radius: 12px; border: 1px solid var(--primary); }
        .poster-scroll-area::-webkit-scrollbar { display: none; }
        .poster-img { width: 100%; display: block; }
        .poster-tip { color: #888; font-size: 13px; margin: 20px 0 15px 0; font-weight: bold; }
        .btn-next { background: var(--primary); color: #000; border: none; padding: 14px 35px; border-radius: 30px; font-weight: 900; font-size: 15px; }
    </style>
</head>
<body>

    <div id="capture-area">
        <div class="header-brand">
            <div class="brand-text">LUXIOU æ™ºèƒ½ç­›æŸ¥çŸ©é˜µ</div>
            <div class="step-badge">é«˜å®šä½“æµ‹æ–¹æ¡ˆ</div>
        </div>

        <div class="radar-section">
            <div class="score-board">
                <div class="score-info">
                    <span class="risk-label">æœºèƒ½å¥åº·ç»¼åˆè¯„åˆ†</span>
                    <span class="risk-score" id="scoreDisplay">95</span>
                </div>
                <div class="status-tag" id="statusTag">æœºèƒ½çŠ¶æ€ä¼˜è‰¯</div>
            </div>
            <div class="radar-container">
                <canvas id="radarCanvas"></canvas>
            </div>
        </div>

        <div class="matrix-scroll" id="scrollArea">
            <div class="question-group">
                <div class="q-title">ä¸€ã€èŒä¸šä¸ä½œæ¯ (Occupation & Lifestyle)</div>
                <div class="tags-grid">
                    <div class="tag-btn" data-impact='{"meta":-10, "posture":-15}' onclick="toggleTag(this)">ğŸ’» æåº¦ä¹…åä¼æ¡ˆ</div>
                    <div class="tag-btn" data-impact='{"joint":-15, "muscle":-10}' onclick="toggleTag(this)">ğŸ§â€â™€ï¸ é•¿æœŸç«™ç«‹/é«˜è·Ÿé‹</div>
                    <div class="tag-btn" data-impact='{"meta":-15, "core":-5}' onclick="toggleTag(this)">ğŸ¥‚ é¢‘ç¹åº”é…¬/é«˜å‹</div>
                    <div class="tag-btn" data-impact='{"posture":-10, "meta":-15}' onclick="toggleTag(this)">ğŸŒ™ ç»å¸¸ç†¬å¤œ/æ˜¼å¤œé¢ å€’</div>
                    <div class="tag-btn custom-add" data-impact='{"meta":-10, "posture":-10}' data-danger="false" data-title="è¯·è¾“å…¥ç‰¹å¼‚æ€§èŒä¸š/ä½œæ¯ï¼š" onclick="openInput(this)">â• æ‰‹åŠ¨å½•å…¥ç‰¹å¼‚æ€§èŒä¸š/ä½œæ¯</div>
                </div>
            </div>

            <div class="question-group">
                <div class="q-title">äºŒã€é¥®é£Ÿä¸ä»£è°¢ (Metabolism)</div>
                <div class="tags-grid">
                    <div class="tag-btn" data-impact='{"meta":-20}' onclick="toggleTag(this)">ğŸ° é‡åº¦ç”œé£Ÿå¥¶èŒ¶æ§</div>
                    <div class="tag-btn" data-impact='{"meta":-15}' onclick="toggleTag(this)">ğŸ” ä¸‰é¤å¤–å–/é‡æ²¹ç›</div>
                    <div class="tag-btn" data-impact='{"meta":-10}' onclick="toggleTag(this)">ğŸ’§ æå°‘é¥®æ°´(å•æ—¥&lt;1L)</div>
                    <div class="tag-btn" data-impact='{"meta":-20, "muscle":-10}' onclick="toggleTag(this)">ğŸ½ï¸ é•¿æœŸæç«¯èŠ‚é£Ÿ</div>
                    <div class="tag-btn custom-add" data-impact='{"meta":-15}' data-danger="false" data-title="è¯·è¾“å…¥ç‰¹æ®Šé¥®é£Ÿä¹ æƒ¯ï¼š" onclick="openInput(this)">â• æ‰‹åŠ¨å½•å…¥ä¸è‰¯é¥®é£Ÿç»“æ„</div>
                </div>
            </div>

            <div class="question-group">
                <div class="q-title">ä¸‰ã€è¿åŠ¨ä¸ä¼¤ç—…å² (Sports & Injuries)</div>
                <div class="tags-grid">
                    <div class="tag-btn danger" data-impact='{"muscle":-20, "core":-10}' onclick="toggleTag(this, true)">ğŸš« å‡ ä¹é›¶è¿åŠ¨åŸºç¡€</div>
                    <div class="tag-btn danger" data-impact='{"core":-25, "posture":-10}' onclick="toggleTag(this, true)">ğŸ‘¼ äº§åæœªç³»ç»Ÿåº·å¤</div>
                    <div class="tag-btn danger" data-impact='{"joint":-25, "muscle":-15}' onclick="toggleTag(this, true)">ğŸ©¹ éª¨éª¼/å…³èŠ‚æ›¾å—æŸ</div>
                    <div class="tag-btn danger" data-impact='{"posture":-20}' onclick="toggleTag(this, true)">âš–ï¸ ä¹ æƒ¯å•ä¾§å‘åŠ›ç¿˜è…¿</div>
                    <div class="tag-btn custom-add" data-impact='{"joint":-25, "muscle":-15, "core":-10}' data-danger="true" data-title="è¯·è¾“å…¥å…·ä½“ä¼¤ç—…ï¼š" onclick="openInput(this)">â• æ‰‹åŠ¨å½•å…¥ç‰¹å¼‚æ€§ä¼¤ç—…å²</div>
                </div>
            </div>

            <div class="question-group">
                <div class="q-title">å››ã€ç–¼ç—›ä¸ä¸é€‚ (Pain Points)</div>
                <div class="tags-grid">
                    <div class="tag-btn danger" data-impact='{"posture":-30, "joint":-10}' onclick="toggleTag(this, true)">âš¡ é¢ˆè‚©é¢‘ç¹é…¸èƒ€</div>
                    <div class="tag-btn danger" data-impact='{"core":-25, "posture":-15}' onclick="toggleTag(this, true)">âš¡ ææ˜“è…°é…¸èƒŒç—›</div>
                    <div class="tag-btn danger" data-impact='{"joint":-30, "core":-10}' onclick="toggleTag(this, true)">âš¡ è†ç›–å¼¹å“ä¸é€‚</div>
                    <div class="tag-btn danger" data-impact='{"posture":-20, "core":-15}' onclick="toggleTag(this, true)">âš¡ éª¨ç›†å‰å€¾/å¡Œè…°</div>
                    <div class="tag-btn custom-add" data-impact='{"joint":-20, "posture":-15}' data-danger="true" data-title="è¯·è¾“å…¥å…·ä½“ä¸é€‚éƒ¨ä½ï¼š" onclick="openInput(this)">â• æ‰‹åŠ¨å½•å…¥å…¶ä»–ä½“æ€/ç–¼ç—›æ„Ÿ</div>
                </div>
            </div>

            <div class="question-group">
                <div class="q-title">äº”ã€é¦–è¦èœ•å˜ç›®æ ‡ (Primary Goal)</div>
                <div class="tags-grid">
                    <div class="tag-btn" data-goal="fatloss" onclick="toggleTag(this)">ğŸ”¥ æé€Ÿå‡è„‚å¡‘å½¢</div>
                    <div class="tag-btn" data-goal="posture" onclick="toggleTag(this)">ğŸ“ ä½“æ€ä¸éª¨éª¼çº æ­£</div>
                    <div class="tag-btn" data-goal="muscle" onclick="toggleTag(this)">ğŸ’ª å¢è‚Œä¸çº¿æ¡é›•åˆ»</div>
                    <div class="tag-btn" data-goal="health" onclick="toggleTag(this)">â¤ï¸ äºšå¥åº·/å¿ƒè‚ºæå‡</div>
                    <div class="tag-btn custom-add" data-goal="custom" data-danger="false" data-title="è¯·è¾“å…¥æ‚¨çš„å®šåˆ¶ç›®æ ‡ï¼š" onclick="openInput(this)">â• æ‰‹åŠ¨å½•å…¥ä¸“å±å®šåˆ¶ç›®æ ‡</div>
                </div>
            </div>

            <div class="signature-section">
                <div class="sig-header">Client Signature / å®¢æˆ·ç­¾å­—æˆæƒ</div>
                <div class="contract-line" onclick="openSigPad()">
                    <span id="sigPlaceholder" class="pulse-text">ç‚¹å‡»å…¨å±æ‰‹å†™ç­¾å</span>
                    <img id="sigResultImg" src="">
                </div>
            </div>

        </div>
    </div> 

    <div class="input-modal" id="customInputModal">
        <div class="input-box">
            <div class="input-title" id="customInputTitle">è¯·è¾“å…¥å†…å®¹</div>
            <input type="text" class="custom-input" id="customInputField" placeholder="åœ¨æ­¤è¾“å…¥..." ontouchstart="this.focus()">
            <div class="modal-btns">
                <button class="modal-btn cancel" onclick="closeInput()">å–æ¶ˆ</button>
                <button class="modal-btn confirm" onclick="confirmInput()">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>

    <div class="sig-modal" id="sigModal">
        <div class="sig-modal-header">è¯·åœ¨ä¸‹æ–¹ç©ºç™½å¤„ç­¾ç½²æ‚¨çš„å§“å</div>
        <canvas id="fullscreenSigCanvas"></canvas>
        <div class="sig-modal-footer">
            <button class="sig-btn cancel" onclick="clearSig()">æ¸…é™¤é‡å†™</button>
            <button class="sig-btn confirm" onclick="saveSig()">ç¡®è®¤ç­¾å‘</button>
        </div>
    </div>

    <div class="bottom-action" id="actionBtnGroup">
        <button class="btn-generate" onclick="generatePoster()">
            <span style="font-size: 20px;">ğŸ“¸</span> ç”Ÿæˆè¯Šæ–­æŠ¥å‘Šå¹¶å­˜æ¡£
        </button>
    </div>

    <div class="poster-overlay" id="posterOverlay">
        <div class="poster-scroll-area"><img id="posterImg" class="poster-img" src="" alt="è¯Šæ–­æµ·æŠ¥"></div>
        <div class="poster-tip"><span style="color:var(--primary)">ğŸ‘‡ é•¿æŒ‰ä¸Šæ–¹å›¾ç‰‡ï¼Œä¿å­˜å®Œæ•´æ¡£æ¡ˆ</span></div>
        <button class="btn-next" onclick="goToNextStep()">è¿›å…¥ PAR-Q åŒ»ç–—æ’æŸ¥ â”</button>
    </div>

    <script>
        const canvas = document.getElementById('radarCanvas');
        const ctx = canvas.getContext('2d');
        const labels = ["æ ¸å¿ƒç¨³å®š", "å…³èŠ‚å¥åº·", "åŸºç¡€ä»£è°¢", "ä½“æ€æ’åˆ—", "è‚Œè‚‰å‡è¡¡"];
        const maxScore = 100;
        let currentScores = { core: 95, joint: 95, meta: 95, posture: 95, muscle: 95 };
        let targetScores = { core: 95, joint: 95, meta: 95, posture: 95, muscle: 95 };

        function drawRadar() {
            if(!canvas) return;
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.parentElement.getBoundingClientRect();
            if(rect.width === 0) return; 
            
            canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            const w = rect.width, h = rect.height;
            const centerX = w / 2; const centerY = h / 2 + 10;
            const radius = Math.min(w, h) / 2 * 0.7; const sides = 5;

            ctx.clearRect(0, 0, w, h);
            ctx.lineWidth = 1;
            for (let level = 1; level <= 4; level++) {
                ctx.beginPath();
                for (let i = 0; i < sides; i++) {
                    let angle = (Math.PI * 2 * i) / sides - Math.PI / 2;
                    let x = centerX + radius * (level / 4) * Math.cos(angle);
                    let y = centerY + radius * (level / 4) * Math.sin(angle);
                    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.strokeStyle = `rgba(212, 175, 55, ${0.1 * level})`; ctx.stroke();
            }

            ctx.fillStyle = "#888"; ctx.font = "bold 11px sans-serif"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            for (let i = 0; i < sides; i++) {
                let angle = (Math.PI * 2 * i) / sides - Math.PI / 2;
                let x = centerX + radius * Math.cos(angle); let y = centerY + radius * Math.sin(angle);
                ctx.beginPath(); ctx.moveTo(centerX, centerY); ctx.lineTo(x, y);
                ctx.strokeStyle = "rgba(255,255,255,0.03)"; ctx.stroke();
                let labelX = centerX + (radius + 25) * Math.cos(angle); let labelY = centerY + (radius + 15) * Math.sin(angle);
                ctx.fillText(labels[i], labelX, labelY);
            }

            ctx.beginPath();
            const keys = ['core', 'joint', 'meta', 'posture', 'muscle'];
            keys.forEach((key, i) => {
                let angle = (Math.PI * 2 * i) / sides - Math.PI / 2;
                let val = Math.max(20, Math.min(100, currentScores[key]));
                let x = centerX + radius * (val / maxScore) * Math.cos(angle); let y = centerY + radius * (val / maxScore) * Math.sin(angle);
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            });
            ctx.closePath();
            
            let totalScore = Math.round(Object.values(currentScores).reduce((a,b)=>a+b, 0) / 5);
            
            // ğŸš€ ä¸‰çº§è‰²å½©é›·è¾¾å¡«å……ï¼šé‡‘(>85) -> æ©™(70-84) -> çº¢(<70)
            ctx.lineWidth = 2;
            if(totalScore >= 85) {
                ctx.fillStyle = "rgba(212, 175, 55, 0.4)"; ctx.strokeStyle = "#D4AF37"; 
            } else if(totalScore >= 70) {
                ctx.fillStyle = "rgba(255, 140, 0, 0.4)"; ctx.strokeStyle = "#FF8C00"; 
            } else {
                ctx.fillStyle = "rgba(178, 34, 34, 0.4)"; ctx.strokeStyle = "#B22222"; 
            }
            ctx.fill(); ctx.stroke(); 
        }

        function animate() {
            let needsUpdate = false;
            const keys = ['core', 'joint', 'meta', 'posture', 'muscle'];
            keys.forEach(key => {
                let diff = targetScores[key] - currentScores[key];
                if (Math.abs(diff) > 0.5) { currentScores[key] += diff * 0.15; needsUpdate = true; }
            });
            if (needsUpdate) { drawRadar(); updateTotalScore(); }
            requestAnimationFrame(animate);
        }

        function updateTotalScore() {
            let total = Math.round(Object.values(currentScores).reduce((a,b)=>a+b, 0) / 5);
            let display = document.getElementById('scoreDisplay');
            let tag = document.getElementById('statusTag');
            display.innerText = total;
            
            // ğŸš€ ä¸‰çº§è¯æœ¯æ§åˆ¶
            if(total >= 85) {
                display.className = "risk-score"; tag.className = "status-tag"; tag.innerText = "æœºèƒ½çŠ¶æ€ä¼˜è‰¯ | ç»§ç»­ä¿æŒ";
            } else if (total >= 70) {
                display.className = "risk-score mod"; tag.className = "status-tag warn"; tag.innerText = "äºšå¥åº·é¢„è­¦ | éœ€å®šåˆ¶é’ˆå¯¹æ€§åº·å¤";
            } else {
                display.className = "risk-score high"; tag.className = "status-tag crit"; tag.innerText = "ä½“å¾çº¢ç¯ | éœ€ä¸¥å¯†ç›‘æµ‹ä¸åŒ»ç–—çº§å¹²é¢„";
            }
        }

        function toggleTag(el, isDanger = false) {
            el.classList.toggle('active');
            if(isDanger && el.classList.contains('active')) el.classList.add('danger');
            recalculateScores();
        }

        // ğŸš€ æ ¸å¿ƒä¿®å¤ï¼šçº¯åŸç”Ÿ DOM å±æ€§è·å–ï¼Œå½»åº•è§„é¿æ‹¬å·è¯­æ³•å´©æºƒ
        function openInput(btn) {
            window.activeBtn = btn;
            window.activeImpact = btn.getAttribute('data-impact');
            window.activeDanger = btn.getAttribute('data-danger') === 'true';
            window.activeGoal = btn.getAttribute('data-goal');
            
            let title = btn.getAttribute('data-title');
            document.getElementById('customInputTitle').innerText = title;
            
            const inputField = document.getElementById('customInputField');
            inputField.value = '';
            
            document.getElementById('customInputModal').style.display = 'flex';
        }
        
        function closeInput() { 
            document.getElementById('customInputField').blur();
            document.getElementById('customInputModal').style.display = 'none'; 
        }
        
        function confirmInput() {
            let text = document.getElementById('customInputField').value;
            if(text && text.trim() !== "") {
                let newTag = document.createElement('div');
                newTag.className = `tag-btn active ${window.activeDanger ? 'danger' : ''}`;
                newTag.style.gridColumn = "span 1"; 
                
                if(window.activeImpact) { newTag.setAttribute('data-impact', window.activeImpact); }
                if(window.activeGoal) { newTag.setAttribute('data-goal', window.activeGoal); }
                
                newTag.innerHTML = `${window.activeDanger ? 'âš ï¸' : 'âœ¨'} ${text.trim()}`;
                newTag.onclick = function() { toggleTag(this, window.activeDanger); };
                
                window.activeBtn.parentNode.insertBefore(newTag, window.activeBtn);
                recalculateScores(); 
                closeInput();
            } else { alert("å†…å®¹ä¸èƒ½ä¸ºç©ºå“¦"); }
        }

        function recalculateScores() {
            let newScores = { core: 95, joint: 95, meta: 95, posture: 95, muscle: 95 };
            document.querySelectorAll('.tag-btn.active').forEach(tag => {
                let impactStr = tag.getAttribute('data-impact');
                if(impactStr) { let impact = JSON.parse(impactStr); for(let key in impact) newScores[key] += impact[key]; }
                if(!impactStr && !tag.getAttribute('data-goal')) newScores.muscle -= 5;
            });
            targetScores = newScores;
        }

        const fSigCanvas = document.getElementById('fullscreenSigCanvas');
        const fSigCtx = fSigCanvas.getContext('2d');
        let fIsDrawing = false;

        function openSigPad() {
            document.body.style.overflow = 'hidden';
            let modal = document.getElementById('sigModal');
            modal.style.display = 'flex';
            const dpr = window.devicePixelRatio || 1;
            fSigCanvas.width = fSigCanvas.clientWidth * dpr; 
            fSigCanvas.height = fSigCanvas.clientHeight * dpr;
            fSigCtx.scale(dpr, dpr); 
            fSigCtx.fillStyle = "#ffffff";
            fSigCtx.fillRect(0, 0, fSigCanvas.width, fSigCanvas.height);
            fSigCtx.lineWidth = 5; fSigCtx.lineCap = 'round'; fSigCtx.strokeStyle = '#000000'; 
        }

        function closeSigPad() {
            document.body.style.overflow = 'auto';
            document.getElementById('sigModal').style.display = 'none';
        }

        function getFPos(e) {
            const rect = fSigCanvas.getBoundingClientRect();
            const x = e.touches ? e.touches[0].clientX : e.clientX;
            const y = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: x - rect.left, y: y - rect.top };
        }

        fSigCanvas.addEventListener('mousedown', e => { fIsDrawing = true; const p = getFPos(e); fSigCtx.beginPath(); fSigCtx.moveTo(p.x, p.y); });
        fSigCanvas.addEventListener('mousemove', e => { if(fIsDrawing){ const p = getFPos(e); fSigCtx.lineTo(p.x, p.y); fSigCtx.stroke(); }});
        fSigCanvas.addEventListener('mouseup', () => fIsDrawing = false); fSigCanvas.addEventListener('mouseout', () => fIsDrawing = false);
        fSigCanvas.addEventListener('touchstart', e => { e.preventDefault(); fIsDrawing = true; const p = getFPos(e); fSigCtx.beginPath(); fSigCtx.moveTo(p.x, p.y); }, {passive: false});
        fSigCanvas.addEventListener('touchmove', e => { e.preventDefault(); if(fIsDrawing){ const p = getFPos(e); fSigCtx.lineTo(p.x, p.y); fSigCtx.stroke(); }}, {passive: false});
        fSigCanvas.addEventListener('touchend', e => { e.preventDefault(); fIsDrawing = false; }, {passive: false});

        function clearSig() { fSigCtx.fillStyle = "#ffffff"; fSigCtx.fillRect(0, 0, fSigCanvas.width, fSigCanvas.height); }

        function saveSig() {
            let dataUrl = fSigCanvas.toDataURL("image/png");
            document.getElementById('sigResultImg').src = dataUrl;
            document.getElementById('sigResultImg').style.display = 'block';
            document.getElementById('sigPlaceholder').style.display = 'none';
            closeSigPad();
        }

        function generatePoster() {
            let goals = []; document.querySelectorAll('.tag-btn.active[data-goal]').forEach(t => goals.push(t.innerText));
            if(goals.length === 0) { alert("è¯·åœ¨ç¬¬äº”é¡¹é€‰æ‹©æˆ–è¾“å…¥ä¸€ä¸ªã€èœ•å˜ç›®æ ‡ã€‘ï¼"); return; }
            if(document.getElementById('sigPlaceholder').style.display !== 'none') {
                alert("è¯·ç‚¹å‡»åº•éƒ¨ã€å®Œæˆæ‰‹å†™ç­¾åã€‘åå†ç”ŸæˆæŠ¥å‘Šï¼"); return;
            }
            if (navigator.vibrate) navigator.vibrate(50);
            let btn = document.querySelector('.btn-generate');
            btn.innerHTML = "â³ æ­£åœ¨ç”Ÿæˆæ¡£æ¡ˆ..."; btn.style.opacity = "0.7"; document.getElementById('actionBtnGroup').style.display = 'none';
            let captureArea = document.getElementById('capture-area');
            html2canvas(captureArea, { backgroundColor: "#050505", scale: 2 }).then(canvas => {
                document.getElementById('actionBtnGroup').style.display = 'block'; btn.innerHTML = "<span style='font-size: 20px;'>ğŸ“¸</span> ç”Ÿæˆè¯Šæ–­æŠ¥å‘Šå¹¶å­˜æ¡£"; btn.style.opacity = "1";
                document.getElementById('posterImg').src = canvas.toDataURL("image/jpeg", 0.9);
                document.getElementById('posterOverlay').style.display = 'flex';
            }).catch(err => {
                alert("ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•ï¼"); document.getElementById('actionBtnGroup').style.display = 'block';
            });
        }
        function goToNextStep() { window.location.href = 'parq.html'; }
        window.onload = () => { setTimeout(() => { drawRadar(); animate(); }, 100); window.addEventListener('resize', drawRadar); };
    </script>
</body>
</html>
