<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LUXIOU | å…¨æ¯æ•°å­—åŒ–è¯Šæ–­ V14.0</title>
    <style>
        :root { --primary: #00f2fe; --accent: #00ff88; --danger: #ff4757; --bg: #0b0f19; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            background: var(--bg); color: #e2e8f0; 
            font-family: "DIN Alternate", -apple-system, "Helvetica Neue", sans-serif; 
            margin: 0; padding: 0; overflow: hidden; touch-action: none;
            display: flex; flex-direction: column; height: 100svh; 
        }
        
        .header-brand { 
            flex: 0 0 55px; width: 100%; display: flex; align-items: center; justify-content: center; 
            background: rgba(11, 15, 25, 0.98); z-index: 50; 
            border-bottom: 1px solid rgba(0,242,254,0.3); box-shadow: 0 4px 15px rgba(0,0,0,0.5); position: relative; 
        }
        .brand-text { font-size: 20px; font-weight: 900; color: #fff; letter-spacing: 3px; text-shadow: 0 0 12px rgba(0,242,254,0.8); }
        .back-btn { position: absolute; left: 15px; color: #fff; text-decoration: none; font-size: 13px; border: 1px solid rgba(255,255,255,0.3); padding: 5px 14px; border-radius: 20px; font-weight: 600; }

        .app-content { flex: 1; min-height: 0; display: flex; flex-direction: column; padding: 12px; }

        .category-box { flex: 0 0 auto; display: flex; gap: 10px; overflow-x: auto; margin-bottom: 12px; padding-bottom: 4px; scrollbar-width: none; }
        .category-box::-webkit-scrollbar { display: none; }
        .cat-item { 
            flex: 0 0 auto; padding: 8px 18px; 
            background: rgba(30, 41, 59, 0.6); border-radius: 20px; 
            font-size: 13px; color: #94a3b8; border: 1px solid rgba(255, 255, 255, 0.1); 
            font-weight: 600; letter-spacing: 0.5px; transition: all 0.3s ease;
        }
        .cat-item.active { 
            background: var(--primary); color: #0b0f19; border: none; 
            box-shadow: 0 0 16px rgba(0,242,254,0.5); font-weight: 900; transform: scale(1.03); 
        }

        .stage-area { flex: 1; min-height: 0; display: flex; gap: 6px; margin-bottom: 12px; }
        .params-side { flex: 0 0 92px; display: flex; flex-direction: column; }
        .param-card { flex: 1; background: rgba(11, 15, 25, 0.8); border-bottom: 1px solid rgba(255,255,255,0.05); padding: 5px; display: flex; flex-direction: column; justify-content: center; position: relative; }
        .card-l { border-left: 3px solid #fff; border-radius: 8px 0 0 8px; align-items: flex-start; }
        .card-r { border-right: 3px solid var(--primary); border-radius: 0 8px 8px 0; align-items: flex-end; text-align: right; }
        .param-card label { font-size: 9px; color: #94a3b8; margin-bottom: 4px; font-weight: bold; }
        
        .mini-wheel { color: var(--primary); font-size: 19px; font-weight: 900; line-height: 1; cursor: ns-resize; touch-action: none; position: relative; display: inline-flex; align-items: baseline; }
        .mini-wheel::after { content: attr(data-unit); font-size: 10px; color: #64748b; margin-left: 2px; font-weight: 600; }
        .diff-tag { font-size: 11px; font-weight: 900; margin-top: 4px; letter-spacing: 0.5px; transition: color 0.3s; }

        .main-viewer { flex: 1; background: #000; border-radius: 12px; position: relative; overflow: hidden; border: 1px solid #334155; box-shadow: 0 8px 25px rgba(0,0,0,0.6); }
        .img-layer { position: absolute; width: 100%; height: 100%; background-size: contain; background-repeat: no-repeat; background-position: center; transition: opacity 0.1s linear; }
        #laserCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; touch-action: none; }

        .control-panel { flex: 0 0 auto; background: rgba(16, 24, 39, 0.95); border-radius: 20px; padding: 15px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 -5px 20px rgba(0,0,0,0.5); }
        .zoom-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        input[type=range] { width: 100%; -webkit-appearance: none; background: #1e293b; height: 5px; border-radius: 3px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 22px; height: 22px; background: #fff; border: 3px solid var(--primary); border-radius: 50%; box-shadow: 0 0 10px var(--primary); }

        /* ä¼˜åŒ–åçš„ 2x2 æŒ‰é’®çŸ©é˜µ */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .lux-btn { background: #1e293b; border: 1px solid #334155; padding: 12px; border-radius: 10px; color: #fff; font-size: 12px; font-weight: bold; text-align: center; display: flex; align-items: center; justify-content: center; gap: 5px;}
        .btn-save { background: var(--primary); color: #000; border: none; box-shadow: 0 4px 15px rgba(0,242,254,0.3); }
        .btn-vault { background: transparent; color: var(--primary); border: 1px solid var(--primary); }

        /* ğŸš€ å…¨æ–°çš„æŠ½å±‰å¼æ¡£æ¡ˆåº“ (Bottom Sheet) */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 9999; 
            display: none; flex-direction: column; justify-content: flex-end; 
            opacity: 0; transition: opacity 0.3s ease; 
        }
        .modal-overlay.show { opacity: 1; }
        .vault-drawer { 
            background: rgba(16, 24, 39, 0.98); width: 100%; max-height: 80vh; height: 75vh;
            border-radius: 24px 24px 0 0; padding: 20px; border-top: 1px solid var(--primary); 
            display: flex; flex-direction: column; box-shadow: 0 -10px 40px rgba(0,242,254,0.15); 
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); 
        }
        .modal-overlay.show .vault-drawer { transform: translateY(0); }
        .drawer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px; }
        .drawer-header h3 { margin: 0; color: #fff; font-size: 18px; font-weight: 900; letter-spacing: 1px;}
        .close-btn { background: #334155; border: none; color: #fff; width: 32px; height: 32px; border-radius: 50%; font-weight: bold; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        
        #vaultList { flex: 1; overflow-y: auto; padding-bottom: 40px; scrollbar-width: none; }
        .v-item-wrap { position: relative; overflow: hidden; margin-bottom: 10px; border-radius: 12px; background: var(--danger); }
        .v-item-content { 
            background: #1e293b; padding: 15px; 
            display: flex; justify-content: space-between; align-items: center; 
            border: 1px solid #334155; border-radius: 12px; 
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); position: relative; z-index: 2; 
        }
        .v-text-area { flex: 1; min-width: 0; margin-right: 10px; }
        .v-title { display: block; color: var(--primary); font-size: 16px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .v-sub { display: block; color: #94a3b8; font-size: 12px; margin-top: 4px; }
        .v-btn-load { flex: 0 0 auto; background: var(--primary); color: #000; border: none; padding: 8px 18px; border-radius: 8px; font-weight: bold; font-size: 13px; box-shadow: 0 4px 10px rgba(0,242,254,0.3); }
        .delete-btn { position: absolute; right: 0; top: 0; height: 100%; width: 80px; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; z-index: 1; }
    </style>
</head>
<body>
    <div class="header-brand">
        <a href="./index.html" class="back-btn">è¿”å›</a>
        <div class="brand-text">LUXIOU å…¨æ¯æ•°å­—åŒ–</div>
    </div>

    <div class="app-content">
        <div class="category-box" id="catBox"></div>
        
        <div class="stage-area">
            <div class="params-side" id="colL"></div>
            <div class="main-viewer">
                <div class="img-layer" id="layB" style="background-image:url('case_before.jpg'); opacity:1;"></div>
                <div class="img-layer" id="layA" style="background-image:url('case_after.jpg'); opacity:0;"></div>
                <canvas id="laserCanvas"></canvas>
            </div>
            <div class="params-side" id="colR"></div>
        </div>

        <div class="control-panel">
            <div class="zoom-row">
                <div><small style="color:var(--primary);font-size:10px;font-weight:bold;">å‰ç…§å˜ç„¦</small> <input type="range" min="50" max="300" value="100" oninput="zoom('layB', this.value)"></div>
                <div><small style="color:var(--primary);font-size:10px;font-weight:bold;">åç…§å˜ç„¦</small> <input type="range" min="50" max="300" value="100" oninput="zoom('layA', this.value)"></div>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:10px; color:#94a3b8; font-weight:bold; margin-bottom:5px;"><span>BEFORE</span><span>æ»‘åŠ¨å±•ç°é›·è¾¾å½¢å˜</span><span>AFTER</span></div>
            <input type="range" min="0" max="100" value="0" id="fadeSlider">
            
            <div class="btn-group">
                <div class="lux-btn" onclick="document.getElementById('fB').click()">ğŸ“· å¯¼å…¥å‰ç…§<input type="file" id="fB" hidden accept="image/*" onchange="processImg(this,'layB')"></div>
                <div class="lux-btn" onclick="document.getElementById('fA').click()">ğŸ“· å¯¼å…¥åç…§<input type="file" id="fA" hidden accept="image/*" onchange="processImg(this,'layA')"></div>
                <div class="lux-btn btn-save" onclick="saveCase()">ğŸ’¾ ä¿å­˜æ¡ˆä¾‹</div>
                <div class="lux-btn btn-vault" onclick="openVault()">ğŸ“‚ å†å²æ¡£æ¡ˆåº“</div>
            </div>
        </div>
    </div>

    <div id="vaultModal" class="modal-overlay">
        <div class="vault-drawer">
            <div class="drawer-header">
                <h3>å†å²å…¨æ¯æ¡£æ¡ˆåº“</h3>
                <button class="close-btn" onclick="closeVault()">Ã—</button>
            </div>
            <div id="vaultList">
                </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('laserCanvas');
        const ctx = canvas.getContext('2d');
        
        let anchorsB = Array(6).fill(0).map((_, i) => ({ x: 0.5, y: 0.15 + i * 0.14 }));
        let anchorsA = Array(6).fill(0).map((_, i) => ({ x: 0.5, y: 0.15 + i * 0.14 }));
        let draggingIdx = -1;
        let currentUnit = "cm";
        let activeSet = anchorsB;

        const db = {
            posture: { name: "ä½“æ€çŸ«æ­£", unit: "cm", labels: ["é¢ˆå‰å¼•", "åœ†è‚©åº¦", "é«˜ä½è‚©", "ç›†å‰å€¾", "è„ŠæŸ±ä¾§", "å‡èƒ¯å®½"], pre: [8.5, 25.0, 2.5, 18.0, 12.0, 98.0], post: [2.1, 8.0, 0.2, 7.0, 2.0, 91.0] },
            shoulder: { name: "ç›´è§’è‚©", unit: "Â°", labels: ["ä¸€å­—è‚©è§’", "æ–œæ–¹è‚Œåš", "é”éª¨å±•åº¦", "è‚©å³°å·®å€¼", "é¢ˆæ ¹å®½åº¦", "èƒŒå¹³æ•´åº¦"], pre: [145.0, 5.8, 150.0, 1.5, 14.0, 12.0], post: [178.0, 3.1, 175.0, 0.2, 11.5, 4.0] },
            postpartum: { name: "äº§ååº·å¤", unit: "cm", labels: ["è…¹ç›´è‚Œéš™", "è€»éª¨å®½åº¦", "å†…è„è„‚è‚ª", "ç›†åº•è‚ŒåŠ›", "è…¹å›´å‡å¯¸", "è…°è…¹åº¦æ•°"], pre: [3.5, 12.0, 15.0, 2.0, 95.0, 9.0], post: [0.2, 9.0, 5.0, 5.0, 78.0, 2.0] },
            muscle: { name: "å¢è‚Œä¸“åœº", unit: "cm", labels: ["ä¸Šè‡‚ç»´åº¦", "èƒ¸å›´å¢é•¿", "å¤§è…¿å›´åº¦", "èƒŒé˜”è‚Œå±•", "åŠ›é‡è¯„çº§", "è‚Œè‚‰è´¨é‡"], pre: [31.0, 95.0, 52.0, 88.0, 2.0, 35.0], post: [38.0, 115.0, 61.0, 112.0, 5.0, 72.0] },
            abs: { name: "é©¬ç”²çº¿", unit: "mm", labels: ["çš®è„‚è„‚è‚ª", "è…¹ç›´è‚Œéš™", "è…°å›´å‡å¯¸", "ä¾§è…°åšåº¦", "æ ¸å¿ƒç¨³åº¦", "è…¹éƒ¨å¹³å¦"], pre: [28.0, 2.5, 82.0, 15.0, 35.0, 12.0], post: [10.0, 0.2, 65.0, 5.0, 120.0, 2.0] },
            fatloss: { name: "å‡è„‚å¡‘å½¢", unit: "%", labels: ["åŸºç¡€ä»£è°¢", "å†…è„è„‚è‚ª", "å…¨èº«è„‚ç‡", "BMIæŒ‡æ•°", "è…°è‡€æ¯”ä¾‹", "æ°´åˆ†å«é‡"], pre: [1250.0, 14.0, 35.0, 28.5, 0.92, 48.0], post: [1550.0, 4.0, 18.0, 22.1, 0.72, 62.0] },
            hip: { name: "èœœæ¡ƒè‡€", unit: "cm", labels: ["è‡€å›´ç»´åº¦", "è‡€çº¿é«˜åº¦", "å¤§è…¿å›´åº¦", "æ ¸å¿ƒç¨³å®š", "è‡€ä¸­è‚Œåš", "ä¾§å‘æ”¯æ’‘"], pre: [88.0, 5.2, 54.0, 3.0, 2.0, 15.0], post: [98.0, 2.1, 51.0, 9.0, 8.0, 85.0] }
        };

        function updateDiffs() {
            const lWheels = document.querySelectorAll('.card-l .mini-wheel');
            const rWheels = document.querySelectorAll('.card-r .mini-wheel');
            const diffTags = document.querySelectorAll('.diff-tag');

            for (let i = 0; i < 6; i++) {
                if (lWheels[i] && rWheels[i] && diffTags[i]) {
                    let lVal = parseFloat(lWheels[i].innerText) || 0;
                    let rVal = parseFloat(rWheels[i].innerText) || 0;
                    let diff = (rVal - lVal).toFixed(1);
                    let sign = diff > 0 ? '+' : '';
                    diffTags[i].innerText = `${sign}${diff}${currentUnit}`;

                    if (diff < 0) {
                        diffTags[i].style.color = "var(--accent)";
                        diffTags[i].style.textShadow = "0 0 8px rgba(0,255,136,0.3)";
                    } else if (diff > 0) {
                        diffTags[i].style.color = "var(--danger)";
                        diffTags[i].style.textShadow = "0 0 8px rgba(255,71,87,0.3)";
                    } else {
                        diffTags[i].style.color = "#475569";
                        diffTags[i].style.textShadow = "none";
                    }
                }
            }
        }

        function initMiniWheel(el) {
            let startY = 0, startVal = 0, isMoving = false;
            el.addEventListener('click', () => {
                const newVal = prompt("è¯·è¾“å…¥ç²¾å‡†å‚æ•°", el.innerText);
                if (newVal !== null && newVal !== "") { el.innerText = parseFloat(newVal).toFixed(1); updateDiffs(); }
            });
            el.addEventListener('touchstart', e => {
                startY = e.touches[0].clientY; startVal = parseFloat(el.innerText) || 0;
                isMoving = true; e.preventDefault(); 
            }, { passive: false });
            el.addEventListener('touchmove', e => {
                if (!isMoving) return;
                const delta = (startY - e.touches[0].clientY) * 0.15;
                el.innerText = (startVal + delta).toFixed(1);
                updateDiffs(); e.preventDefault();
            }, { passive: false });
            el.addEventListener('touchend', () => { isMoving = false; });
        }

        function draw() {
            canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let v = document.getElementById('fadeSlider').value / 100;

            for(let i=0; i<6; i++) {
                let currX = anchorsB[i].x * (1 - v) + anchorsA[i].x * v;
                let currY = anchorsB[i].y * (1 - v) + anchorsA[i].y * v;
                
                const boxY = (i * (canvas.height / 6)) + (canvas.height / 12);
                ctx.strokeStyle = "rgba(0, 242, 254, 0.5)"; ctx.lineWidth = 1.2; ctx.setLineDash([5, 4]);
                
                ctx.beginPath(); ctx.moveTo(0, boxY); ctx.lineTo(currX * canvas.width, currY * canvas.height); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(canvas.width, boxY); ctx.lineTo(currX * canvas.width, currY * canvas.height); ctx.stroke();
                
                ctx.setLineDash([]); ctx.fillStyle = "#00ff88"; ctx.beginPath();
                ctx.arc(currX * canvas.width, currY * canvas.height, 5, 0, Math.PI*2); ctx.fill();
            }
        }

        function zoom(target, val) { document.getElementById(target).style.transform = `scale(${val/100})`; }

        function loadSetup(key, el) {
            const d = db[key];
            currentUnit = d.unit; 
            if(el) { document.querySelectorAll('.cat-item').forEach(i => i.classList.remove('active')); el.classList.add('active'); }
            let hL = '', hR = '';
            d.labels.forEach((l, i) => {
                hL += `<div class="param-card card-l"><label>${l}(å‰)</label><div class="mini-wheel" data-unit="${d.unit}">${d.pre[i].toFixed(1)}</div></div>`;
                hR += `<div class="param-card card-r"><label>${l}(å)</label><div class="mini-wheel" data-unit="${d.unit}">${d.post[i].toFixed(1)}</div><div class="diff-tag">0.0${d.unit}</div></div>`;
            });
            document.getElementById('colL').innerHTML = hL; document.getElementById('colR').innerHTML = hR;
            document.querySelectorAll('.mini-wheel').forEach(initMiniWheel);
            updateDiffs(); draw();
        }

        function processImg(i, t) {
            if(i.files[0]){
                const r = new FileReader();
                r.onload = e => {
                    const img = new Image();
                    img.onload = () => {
                        const canvasTmp = document.createElement('canvas');
                        const maxW = 800; const scale = maxW / img.width;
                        canvasTmp.width = maxW; canvasTmp.height = img.height * scale;
                        canvasTmp.getContext('2d').drawImage(img, 0, 0, canvasTmp.width, canvasTmp.height);
                        document.getElementById(t).style.backgroundImage = `url('${canvasTmp.toDataURL('image/jpeg', 0.6)}')`;
                        draw();
                    };
                    img.src = e.target.result;
                };
                r.readAsDataURL(i.files[0]);
            }
        }
        
        function saveCase() {
            const name = prompt("è¾“å…¥å®¢æˆ·å§“åä¿å­˜ï¼š"); if(!name) return;
            const vault = JSON.parse(localStorage.getItem('LUX_V14_DB') || '[]');
            const preVals = Array.from(document.querySelectorAll('.card-l .mini-wheel')).map(s => s.innerText);
            const postVals = Array.from(document.querySelectorAll('.card-r .mini-wheel')).map(s => s.innerText);
            vault.unshift({ 
                id: Date.now(), name, type: document.querySelector('.cat-item.active').innerText, 
                imgB: document.getElementById('layB').style.backgroundImage, 
                imgA: document.getElementById('layA').style.backgroundImage, 
                anchorsB, anchorsA, preVals, postVals 
            });
            localStorage.setItem('LUX_V14_DB', JSON.stringify(vault)); 
            alert("æ¡£æ¡ˆå·²ä¿å­˜ï¼æ‚¨å¯ä»¥ç‚¹å‡»ã€å†å²æ¡£æ¡ˆåº“ã€‘æŸ¥çœ‹ã€‚");
        }

        // æŠ½å±‰ç³»ç»Ÿé€»è¾‘
        function openVault() {
            renderVault();
            const modal = document.getElementById('vaultModal');
            modal.style.display = 'flex';
            // å»¶è¿Ÿä¸€ç‚¹æ·»åŠ  class ä»¥è§¦å‘è¿‡æ¸¡åŠ¨ç”»
            setTimeout(() => modal.classList.add('show'), 10);
        }

        function closeVault() {
            const modal = document.getElementById('vaultModal');
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 300); // ç­‰å¾…åŠ¨ç”»å®Œæˆ
        }

        function deleteItem(id) {
            let vault = JSON.parse(localStorage.getItem('LUX_V14_DB') || '[]');
            vault = vault.filter(i => i.id !== id);
            localStorage.setItem('LUX_V14_DB', JSON.stringify(vault));
            renderVault();
        }

        function loadCase(id) {
            const v = JSON.parse(localStorage.getItem('LUX_V14_DB') || '[]').find(x => x.id === id);
            if(v) {
                document.getElementById('layB').style.backgroundImage = v.imgB; document.getElementById('layA').style.backgroundImage = v.imgA;
                if(v.anchorsB && v.anchorsA) { anchorsB = v.anchorsB; anchorsA = v.anchorsA; }
                const lWheel = document.querySelectorAll('.card-l .mini-wheel');
                const rWheel = document.querySelectorAll('.card-r .mini-wheel');
                v.preVals.forEach((s, i) => lWheel[i].innerText = s);
                v.postVals.forEach((s, i) => rWheel[i].innerText = s);
                updateDiffs(); draw();
                closeVault(); // è½½å…¥æˆåŠŸåè‡ªåŠ¨æ”¶èµ·æŠ½å±‰
            }
        }

        function renderVault() {
            const v = JSON.parse(localStorage.getItem('LUX_V14_DB') || '[]');
            const list = document.getElementById('vaultList');
            if(v.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#64748b; padding-top: 40px;">æš‚æ— å†å²æ¡£æ¡ˆ</div>';
                return;
            }
            list.innerHTML = v.map(i => `
                <div class="v-item-wrap">
                    <div class="delete-btn" onclick="deleteItem(${i.id})">åˆ é™¤</div>
                    <div class="v-item-content" ontouchstart="swipeStart(event)" ontouchmove="swipeMove(event)" ontouchend="swipeEnd(event)">
                        <div class="v-text-area">
                            <span class="v-title">${i.name}</span>
                            <span class="v-sub">${i.type}</span>
                        </div>
                        <button class="v-btn-load" onclick="loadCase(${i.id})">è½½å…¥å…¨æ¯</button>
                    </div>
                </div>
            `).join('');
        }

        let swipeX = 0;
        function swipeStart(e) { swipeX = e.touches[0].clientX; e.stopPropagation(); }
        function swipeMove(e) {
            let diff = e.touches[0].clientX - swipeX;
            if (diff < 0 && diff > -80) e.currentTarget.style.transform = `translateX(${diff}px)`;
        }
        function swipeEnd(e) {
            let diff = e.changedTouches[0].clientX - swipeX;
            e.currentTarget.style.transform = diff < -40 ? `translateX(-80px)` : `translateX(0)`;
        }

        const getCoord = (e, axis) => {
            const rect = canvas.getBoundingClientRect();
            const val = e.touches ? (axis === 'x' ? e.touches[0].clientX : e.touches[0].clientY) : (axis === 'x' ? e.clientX : e.clientY);
            return (val - (axis === 'x' ? rect.left : rect.top)) / (axis === 'x' ? canvas.width : canvas.height);
        };
        
        canvas.addEventListener('touchstart', e => {
            let slider = document.getElementById('fadeSlider');
            let v = slider.value / 100;
            let displayPts = anchorsB.map((b, i) => ({ x: b.x * (1 - v) + anchorsA[i].x * v, y: b.y * (1 - v) + anchorsA[i].y * v }));
            const x = getCoord(e, 'x'); const y = getCoord(e, 'y');
            draggingIdx = displayPts.findIndex(a => Math.sqrt((a.x-x)**2 + (a.y-y)**2) < 0.08);
            
            if(draggingIdx !== -1) {
                if(v <= 0.5) {
                    slider.value = 0; activeSet = anchorsB;
                    document.getElementById('layA').style.opacity = 0; document.getElementById('layB').style.opacity = 1;
                } else {
                    slider.value = 100; activeSet = anchorsA;
                    document.getElementById('layA').style.opacity = 1; document.getElementById('layB').style.opacity = 0;
                }
                draw(); e.preventDefault(); 
            }
        }, {passive: false});

        canvas.addEventListener('touchmove', e => {
            if(draggingIdx !== -1) {
                activeSet[draggingIdx] = { x: Math.max(0, Math.min(1, getCoord(e, 'x'))), y: Math.max(0, Math.min(1, getCoord(e, 'y'))) };
                draw(); e.preventDefault();
            }
        }, {passive: false});
        window.addEventListener('touchend', () => draggingIdx = -1);

        document.getElementById('fadeSlider').oninput = e => {
            document.getElementById('layA').style.opacity = e.target.value / 100;
            document.getElementById('layB').style.opacity = 1 - (e.target.value / 100);
            draw(); 
        };

        window.onload = () => {
            document.getElementById('catBox').innerHTML = Object.keys(db).map((k, i) => `<div class="cat-item ${i===0?'active':''}" onclick="loadSetup('${k}', this)">${db[k].name}</div>`).join('');
            loadSetup('posture'); 
        };
    </script>
</body>
</html>
