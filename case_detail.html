<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LUXIOU | Êï∞Â≠óÂåñÂÖ®ÊÅØÊ°£Ê°à V10.1</title>
    <style>
        :root { --primary: #00f2fe; --accent: #00ff88; --bg: #0b0f19; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); color: #e2e8f0; font-family: -apple-system, sans-serif; margin: 0; padding: 0; overflow: hidden; touch-action: none; }
        
        .header-brand { position: fixed; top: 0; left: 0; width: 100%; height: 50px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 5000; border-bottom: 2px solid var(--primary); }
        .brand-text { font-size: 20px; font-weight: 900; color: #fff; letter-spacing: 2px; text-shadow: 0 0 10px var(--primary); }
        .back-btn { position: absolute; left: 15px; color: #fff; text-decoration: none; font-size: 12px; border: 1px solid #444; padding: 5px 12px; border-radius: 20px; }

        .app-wrap { width: 100vw; height: 100vh; display: flex; flex-direction: column; padding: 10px; padding-top: 55px; }

        .category-box { display: flex; gap: 8px; overflow-x: auto; margin-bottom: 10px; padding-bottom: 5px; scrollbar-width: none; }
        .cat-item { flex: 0 0 auto; padding: 8px 16px; background: #161e2e; border-radius: 10px; font-size: 13px; color: #fff; border: 1px solid #444; font-weight: bold; }
        .cat-item.active { background: var(--primary); color: #000; border-color: #fff; box-shadow: 0 0 15px var(--primary); }

        .stage-area { position: relative; flex: 1; width: 100%; display: flex; gap: 4px; margin-bottom: 10px; }
        .params-side { flex: 0 0 90px; display: flex; flex-direction: column; }
        .param-card { flex: 1; background: rgba(11, 15, 25, 0.9); border-bottom: 1px solid rgba(255,255,255,0.05); padding: 5px; display: flex; flex-direction: column; justify-content: center; position: relative; }
        .card-l { border-left: 4px solid #fff; }
        .card-r { border-right: 4px solid var(--primary); text-align: right; }
        .param-card label { font-size: 9px; color: #aaa; margin-bottom: 2px; pointer-events: none; }
        
        /* ‰∫§‰∫íÊï∞ÂÄºÂå∫ */
        .mini-wheel { color: var(--primary); font-size: 18px; font-weight: 900; height: 24px; line-height: 24px; cursor: ns-resize; user-select: none; border-radius: 4px; background: rgba(0,242,254,0.05); }

        .main-viewer { flex: 1; background: #000; border-radius: 15px; position: relative; overflow: hidden; border: 1.5px solid #333; }
        .img-layer { position: absolute; width: 100%; height: 100%; background-size: contain; background-repeat: no-repeat; background-position: center; transition: 0.3s; }
        #laserCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; touch-action: none; }

        .control-panel { background: rgba(16, 24, 39, 0.9); border-radius: 20px; padding: 12px; border: 1px solid rgba(255,255,255,0.1); }
        .zoom-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 8px; }
        input[type=range] { width: 100%; -webkit-appearance: none; background: #1a2234; height: 5px; border-radius: 3px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 22px; height: 22px; background: #fff; border: 3px solid var(--primary); border-radius: 50%; }

        .btn-group { display: grid; grid-template-columns: 1fr 1fr 1.2fr; gap: 10px; margin-top: 5px; }
        .lux-btn { background: #1a2234; border: 1px solid #333; padding: 10px; border-radius: 10px; color: #fff; font-size: 11px; font-weight: bold; text-align: center; }
        .btn-save { background: var(--primary); color: #000; border: none; box-shadow: 0 0 15px var(--primary); }

        #vault { height: 90px; overflow-y: auto; margin-top: 10px; border-top: 1px solid #222; }
        .v-item-wrap { position: relative; overflow: hidden; margin-top: 6px; border-radius: 8px; }
        .v-item-content { position: relative; z-index: 2; background: #161e2e; padding: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #333; transition: transform 0.3s ease; }
        .delete-btn { position: absolute; right: 0; top: 0; height: 100%; width: 70px; background: #ff4757; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; z-index: 1; border-radius: 0 8px 8px 0; }
    </style>
</head>
<body>
    <div class="header-brand">
        <a href="./index.html" class="back-btn">ËøîÂõû</a>
        <div class="brand-text">LUXIOU ÂÖ®ÊÅØÊï∞Â≠óÂåñ</div>
    </div>

    <div class="app-wrap">
        <div class="category-box" id="catBox"></div>
        <div class="stage-area">
            <div class="params-side" id="colL"></div>
            <div class="main-viewer">
                <div class="img-layer" id="layB" style="background-image:url('case_before.jpg'); opacity:1;"></div>
                <div class="img-layer" id="layA" style="background-image:url('case_after.jpg'); opacity:0;"></div>
                <canvas id="laserCanvas"></canvas>
            </div>
            <div class="params-side" id="colR"></div>
        </div>

        <div class="control-panel">
            <div class="zoom-row">
                <div><small style="color:var(--primary);font-size:9px">ÂâçÁº©Êîæ</small> <input type="range" min="50" max="300" value="100" oninput="zoom('layB', this.value)"></div>
                <div><small style="color:var(--primary);font-size:9px">ÂêéÁº©Êîæ</small> <input type="range" min="50" max="300" value="100" oninput="zoom('layA', this.value)"></div>
            </div>
            <input type="range" min="0" max="100" value="0" id="fadeSlider" style="margin-bottom:10px;">
            <div class="btn-group">
                <div class="lux-btn" onclick="document.getElementById('fB').click()">üì∑ ÂØºÂÖ•ÂâçÁÖß<input type="file" id="fB" hidden accept="image/*" onchange="processImg(this,'layB')"></div>
                <div class="lux-btn" onclick="document.getElementById('fA').click()">üì∑ ÂØºÂÖ•ÂêéÁÖß<input type="file" id="fA" hidden accept="image/*" onchange="processImg(this,'layA')"></div>
                <div class="lux-btn btn-save" onclick="saveCase()">üíæ ‰øùÂ≠òÊ°à‰æã</div>
            </div>
            <div id="vault"></div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('laserCanvas');
        const ctx = canvas.getContext('2d');
        let anchors = Array(6).fill(0).map((_, i) => ({ x: 0.5, y: 0.15 + i * 0.14 }));
        let draggingIdx = -1;

        const db = {
            posture: { name: "‰ΩìÊÄÅÁü´Ê≠£", labels: ["È¢àÊ§éÂâçÂºï", "ÂúÜËÇ©ÂÅèÁ¶ª", "È´ò‰ΩéËÇ©Â∑Æ", "È™®ÁõÜÂâçÂÄæ", "ËÑäÊü±‰æßÂÄæ", "ÂÅáËÉØÂÆΩÂ∫¶"] },
            shoulder: { name: "Áõ¥ËßíËÇ©", labels: ["‰∏ÄÂ≠óËÇ©Ëßí", "ÊñúÊñπËÇåÂéö", "ÈîÅÈ™®Â±ïÂ∫¶", "ËÇ©Â≥∞Â∑ÆÂÄº", "È¢àÊ†πÂÆΩÂ∫¶", "ËÉåÂπ≥Êï¥Â∫¶"] },
            postpartum: { name: "‰∫ßÂêéÂ∫∑Â§ç", labels: ["ËÖπÁõ¥ËÇåÈöô", "ËÄªÈ™®ÂÆΩÂ∫¶", "ÂÜÖËÑèËÑÇËÇ™", "ÁõÜÂ∫ïËÇåÂäõ", "ËÖπÂõ¥ÂáèÂØ∏", "ËÖ∞ËÖ∞Âõ¥Â∫¶"] },
            muscle: { name: "Â¢ûËÇå‰∏ìÂú∫", labels: ["‰∏äËáÇÁª¥Â∫¶", "ËÉ∏Âõ¥Â¢ûÈïø", "Â§ßËÖøÂõ¥Â∫¶", "ËÉåÈòîËÇåÂ±ï", "ÂäõÈáèËØÑÁ∫ß", "ËÇåËÇâË¥®Èáè"] },
            abs: { name: "È©¨Áî≤Á∫ø", labels: ["ÁöÆ‰∏ãËÑÇËÇ™", "ËÖπÁõ¥ËÇåÈöô", "ËÖ∞Âõ¥ÂáèÂØ∏", "‰æßËÖ∞ÂéöÂ∫¶", "Ê†∏ÂøÉÁ®≥Â∫¶", "ËÖπÈÉ®Âπ≥Êï¥"] },
            fatloss: { name: "ÂáèËÑÇÂ°ëÂΩ¢", labels: ["Âü∫Á°Ä‰ª£Ë∞¢", "ÂÜÖËÑèËÑÇËÇ™", "ÂÖ®Ë∫´ËÑÇÁéá", "BMIÊåáÊï∞", "ËÖ∞ËáÄÊØî‰æã", "Ê∞¥ÂàÜÂê´Èáè"] },
            hip: { name: "ËúúÊ°ÉËáÄ", labels: ["ËáÄÂõ¥Áª¥Â∫¶", "ËáÄÁ∫øÈ´òÂ∫¶", "Â§ßËÖøÂõ¥Â∫¶", "Ê†∏ÂøÉÁ®≥ÂÆöÊÄß", "ËáÄ‰∏≠ËÇåÂéö", "‰æßÂêëÊîØÊíë"] }
        };

        // ÈáçÊñ∞ËÆæËÆ°ÁöÑÊï∞ÂÄºË∞ÉÊï¥ÈÄªËæëÔºö‰øÆÂ§çÊªëÂä®Âç°Ê≠ª
        function initMiniWheel(el) {
            let startY = 0;
            let startVal = 0;

            el.addEventListener('touchstart', e => {
                startY = e.touches[0].clientY;
                startVal = parseFloat(el.innerText) || 0;
                e.stopPropagation();
            }, { passive: false });

            el.addEventListener('touchmove', e => {
                const delta = (startY - e.touches[0].clientY) * 0.15; // Ë∞ÉÊï¥ÁÅµÊïèÂ∫¶
                el.innerText = (startVal + delta).toFixed(1);
                e.preventDefault();
            }, { passive: false });

            // Â¢ûÂä†ÁÇπÂáªÊâãÂä®‰øÆÊîπÂäüËÉΩ‰Ωú‰∏∫Â§á‰ªΩ
            el.addEventListener('dblclick', () => {
                const newVal = prompt("ÊâãÂä®ËæìÂÖ•Êï∞ÂÄº", el.innerText);
                if (newVal !== null) el.innerText = parseFloat(newVal).toFixed(1);
            });
        }

        function draw() {
            canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            anchors.forEach((pt, i) => {
                const boxY = (i * (canvas.height / 6)) + (canvas.height / 12);
                ctx.strokeStyle = "rgba(0, 242, 254, 0.4)"; ctx.setLineDash([5, 5]);
                ctx.beginPath(); ctx.moveTo(0, boxY); ctx.lineTo(pt.x*canvas.width, pt.y*canvas.height); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(canvas.width, boxY); ctx.lineTo(pt.x*canvas.width, pt.y*canvas.height); ctx.stroke();
                ctx.setLineDash([]); ctx.fillStyle = "#00ff88"; ctx.beginPath();
                ctx.arc(pt.x*canvas.width, pt.y*canvas.height, 6, 0, Math.PI*2); ctx.fill();
            });
        }

        function zoom(target, val) { document.getElementById(target).style.transform = `scale(${val/100})`; }

        function loadSetup(key, el) {
            const d = db[key];
            if(el) { document.querySelectorAll('.cat-item').forEach(i => i.classList.remove('active')); el.classList.add('active'); }
            let hL = '', hR = '';
            d.labels.forEach(l => {
                hL += `<div class="param-card card-l"><label>${l}</label><div class="mini-wheel">0.0</div></div>`;
                hR += `<div class="param-card card-r"><label>${l}</label><div class="mini-wheel">0.0</div></div>`;
            });
            document.getElementById('colL').innerHTML = hL; document.getElementById('colR').innerHTML = hR;
            document.querySelectorAll('.mini-wheel').forEach(initMiniWheel);
            draw();
        }

        function processImg(i, t) {
            if(i.files[0]){
                const r = new FileReader();
                r.onload = e => {
                    const img = new Image();
                    img.onload = () => {
                        const canvasTmp = document.createElement('canvas');
                        const maxW = 800; const scale = maxW / img.width;
                        canvasTmp.width = maxW; canvasTmp.height = img.height * scale;
                        canvasTmp.getContext('2d').drawImage(img, 0, 0, canvasTmp.width, canvasTmp.height);
                        document.getElementById(t).style.backgroundImage = `url('${canvasTmp.toDataURL('image/jpeg', 0.6)}')`;
                        draw();
                    };
                    img.src = e.target.result;
                };
                r.readAsDataURL(i.files[0]);
            }
        }
        
        function saveCase() {
            const name = prompt("Â≠òÊ°£Âêç"); if(!name) return;
            const vault = JSON.parse(localStorage.getItem('LUX_V10_1_DB') || '[]');
            const preVals = Array.from(document.querySelectorAll('.card-l .mini-wheel')).map(s => s.innerText);
            const postVals = Array.from(document.querySelectorAll('.card-r .mini-wheel')).map(s => s.innerText);
            vault.unshift({ id: Date.now(), name, type: document.querySelector('.cat-item.active').innerText, imgB: document.getElementById('layB').style.backgroundImage, imgA: document.getElementById('layA').style.backgroundImage, anchors, preVals, postVals });
            localStorage.setItem('LUX_V10_1_DB', JSON.stringify(vault)); renderVault();
        }

        function deleteItem(id) {
            let vault = JSON.parse(localStorage.getItem('LUX_V10_1_DB') || '[]');
            vault = vault.filter(i => i.id !== id);
            localStorage.setItem('LUX_V10_1_DB', JSON.stringify(vault));
            renderVault();
        }

        function loadCase(id) {
            const v = JSON.parse(localStorage.getItem('LUX_V10_1_DB') || '[]').find(x => x.id === id);
            if(v) {
                document.getElementById('layB').style.backgroundImage = v.imgB; document.getElementById('layA').style.backgroundImage = v.imgA;
                anchors = v.anchors; 
                document.querySelectorAll('.card-l .mini-wheel').forEach((s, i) => s.innerText = v.preVals[i]);
                document.querySelectorAll('.card-r .mini-wheel').forEach((s, i) => s.innerText = v.postVals[i]);
                draw();
            }
        }

        function renderVault() {
            const v = JSON.parse(localStorage.getItem('LUX_V10_1_DB') || '[]');
            const container = document.getElementById('vault');
            container.innerHTML = v.map(i => `
                <div class="v-item-wrap" data-id="${i.id}">
                    <div class="delete-btn" onclick="deleteItem(${i.id})">Âà†Èô§</div>
                    <div class="v-item-content" ontouchstart="swipeStart(event)" ontouchmove="swipeMove(event)" ontouchend="swipeEnd(event)">
                        <span><b>${i.name}</b> <small>(${i.type})</small></span>
                        <button onclick="loadCase(${i.id})" style="background:var(--primary); border:none; padding:6px 12px; border-radius:6px; font-weight:bold;">ËΩΩÂÖ•</button>
                    </div>
                </div>
            `).join('');
        }

        let swipeX = 0;
        function swipeStart(e) { swipeX = e.touches[0].clientX; e.stopPropagation(); }
        function swipeMove(e) {
            let diff = e.touches[0].clientX - swipeX;
            if (diff < 0 && diff > -70) e.currentTarget.style.transform = `translateX(${diff}px)`;
        }
        function swipeEnd(e) {
            let diff = e.changedTouches[0].clientX - swipeX;
            e.currentTarget.style.transform = diff < -35 ? `translateX(-70px)` : `translateX(0)`;
        }

        const getCoord = (e, axis) => {
            const rect = canvas.getBoundingClientRect();
            const val = e.touches ? (axis === 'x' ? e.touches[0].clientX : e.touches[0].clientY) : (axis === 'x' ? e.clientX : e.clientY);
            return (val - (axis === 'x' ? rect.left : rect.top)) / (axis === 'x' ? canvas.width : canvas.height);
        };
        canvas.addEventListener('touchstart', e => {
            const x = getCoord(e, 'x'); const y = getCoord(e, 'y');
            draggingIdx = anchors.findIndex(a => Math.sqrt((a.x-x)**2 + (a.y-y)**2) < 0.08);
            if(draggingIdx !== -1) e.preventDefault(); 
        }, {passive: false});
        canvas.addEventListener('touchmove', e => {
            if(draggingIdx !== -1) {
                anchors[draggingIdx] = { x: Math.max(0, Math.min(1, getCoord(e, 'x'))), y: Math.max(0, Math.min(1, getCoord(e, 'y'))) };
                draw(); e.preventDefault();
            }
        }, {passive: false});
        window.addEventListener('touchend', () => draggingIdx = -1);

        document.getElementById('fadeSlider').oninput = e => {
            document.getElementById('layA').style.opacity = e.target.value / 100;
            document.getElementById('layB').style.opacity = 1 - (e.target.value / 100);
        };

        window.onload = () => {
            document.getElementById('catBox').innerHTML = Object.keys(db).map((k, i) => `<div class="cat-item ${i===0?'active':''}" onclick="loadSetup('${k}', this)">${db[k].name}</div>`).join('');
            loadSetup('posture'); renderVault();
        };
    </script>
</body>
</html>
