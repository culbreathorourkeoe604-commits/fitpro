<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LUXIOU | ACE åŒ»ç–—çº§é£é™©æ’æŸ¥</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #E2C07C; --accent: #D4AF37; --danger: #D9534F; --bg: #0A0A0C; --surface: #141418; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; margin: 0; padding: 0; }
        
        body { background: var(--bg); color: #e2e8f0; font-family: "DIN Alternate", -apple-system, sans-serif; display: flex; flex-direction: column; height: 100svh; overflow: hidden; -webkit-font-smoothing: antialiased; }
        #capture-area { background: var(--bg); display: flex; flex-direction: column; height: 100%; width: 100%; }

        .header-brand { flex: 0 0 60px; width: 100%; display: flex; align-items: center; justify-content: center; background: rgba(10, 10, 12, 0.95); z-index: 50; border-bottom: 1px solid rgba(217, 83, 79, 0.2); }
        .brand-text { font-size: 18px; font-weight: 900; color: #fff; letter-spacing: 2px; }
        .step-badge { position: absolute; right: 15px; background: rgba(217, 83, 79, 0.1); border: 1px solid var(--danger); color: var(--danger); font-size: 10px; padding: 4px 8px; border-radius: 12px; font-weight: bold; }

        .radar-section { flex: 0 0 auto; display: flex; flex-direction: column; background: radial-gradient(circle at center, rgba(20, 20, 24, 0.9) 0%, var(--bg) 100%); border-bottom: 1px solid rgba(255,255,255,0.03); padding-top: 15px; }
        .score-board { display: flex; justify-content: space-between; align-items: flex-start; padding: 0 20px; z-index: 2; height: 65px;}
        .score-info { display: flex; flex-direction: column; }
        .risk-label { font-size: 11px; color: #8A92A3; font-weight: 900; letter-spacing: 1px; }
        .risk-score { font-size: 32px; font-weight: 900; color: var(--primary); text-shadow: 0 4px 15px rgba(226, 192, 124, 0.3); line-height: 1; margin: 6px 0; transition: color 0.3s;}
        .risk-score.high { color: var(--danger); text-shadow: 0 4px 15px rgba(217, 83, 79, 0.3); }
        
        .slogan-box { font-size: 11px; font-weight: bold; padding: 6px 10px; border-radius: 6px; background: rgba(226, 192, 124, 0.08); color: var(--primary); border: 1px solid rgba(226, 192, 124, 0.2); max-width: 170px; line-height: 1.4; transition: 0.3s;}
        .slogan-box.warn { background: rgba(212, 175, 55, 0.08); color: var(--accent); border-color: rgba(212, 175, 55, 0.3); }
        .slogan-box.crit { background: rgba(217, 83, 79, 0.08); color: var(--danger); border-color: rgba(217, 83, 79, 0.3); }

        .radar-container { position: relative; width: 100%; height: 180px; margin-top: 0px; }
        #parqRadar { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; }

        .q-list { flex: 1; overflow-y: auto; padding: 10px 15px 120px 15px; scrollbar-width: none; }
        .q-list::-webkit-scrollbar { display: none; }
        
        .cat-title { font-size: 13px; font-weight: 900; color: var(--primary); margin: 20px 0 12px 0; border-left: 3px solid var(--primary); padding-left: 8px; }
        
        .q-item { background: var(--surface); border: 1px solid rgba(255,255,255,0.03); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
        .q-text { font-size: 13px; color: #D1D5DB; line-height: 1.6; font-weight: bold; margin-bottom: 15px; }
        
        .ans-group { display: flex; gap: 10px; }
        .ans-btn { flex: 1; padding: 12px; text-align: center; border-radius: 8px; font-size: 13px; font-weight: bold; color: #8A92A3; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); transition: 0.2s; }
        .ans-btn.no.active { background: rgba(226, 192, 124, 0.08); border-color: var(--primary); color: var(--primary); }
        .ans-btn.yes.active { background: rgba(217, 83, 79, 0.08); border-color: var(--danger); color: var(--danger); box-shadow: inset 0 0 10px rgba(217, 83, 79, 0.15); }

        /* å…¨æ–°ç­¾åç»“æœå±•ç¤ºåŒº */
        .signature-section { margin-top: 30px; padding: 20px; background: var(--surface); border-radius: 12px; border: 1px solid rgba(255,255,255,0.03); }
        .sig-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .sig-title { font-size: 13px; font-weight: bold; color: #D1D5DB; }
        .sig-result-box { width: 100%; height: 100px; background: rgba(255,255,255,0.02); border: 1px dashed #475569; border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; transition: 0.3s; }
        .sig-result-box:active { background: rgba(255,255,255,0.05); }
        .sig-placeholder { color: var(--primary); font-size: 13px; font-weight: bold; letter-spacing: 1px; }
        #sigResultImg { width: 100%; height: 100%; object-fit: contain; display: none; filter: drop-shadow(0 0 2px rgba(226, 192, 124, 0.5)); }

        .bottom-action { position: fixed; bottom: 0; left: 0; width: 100%; padding: 15px 20px 25px 20px; background: linear-gradient(to top, rgba(10,10,12,1) 60%, rgba(10,10,12,0)); z-index: 10; pointer-events: none;}
        .btn-generate { pointer-events: auto; width: 100%; background: linear-gradient(135deg, #E2C07C, #D4AF37); color: #0A0A0C; border: none; padding: 16px; border-radius: 12px; font-size: 15px; font-weight: 900; box-shadow: 0 8px 20px rgba(226, 192, 124, 0.2); display: flex; justify-content: center; align-items: center; gap: 8px; }

        /* ğŸš€ å…¨å±ç­¾å­—ç‰ˆ Modal */
        .sig-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0A0A0C; z-index: 100000; flex-direction: column; }
        .sig-modal-header { height: 60px; display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: bold; font-size: 16px; border-bottom: 1px solid rgba(226,192,124,0.2); background: #141418; }
        #fullscreenSigCanvas { flex: 1; width: 100%; touch-action: none; background: #0A0A0C; }
        .sig-modal-footer { height: 80px; display: flex; gap: 15px; padding: 15px 20px; background: #141418; border-top: 1px solid rgba(255,255,255,0.05); }
        .modal-btn { flex: 1; padding: 12px; border-radius: 8px; font-size: 15px; font-weight: bold; border: none; }
        .modal-btn.cancel { background: #2A2A35; color: #8A92A3; }
        .modal-btn.confirm { background: var(--primary); color: #0A0A0C; }

        .poster-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 99999; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .poster-scroll-area { max-height: 70vh; width: 100%; overflow-y: auto; border-radius: 12px; border: 1px solid var(--danger); box-shadow: 0 10px 40px rgba(217, 83, 79, 0.2); }
        .poster-scroll-area::-webkit-scrollbar { display: none; }
        .poster-img { width: 100%; display: block; }
        .poster-tip { color: #8A92A3; font-size: 13px; margin: 20px 0 15px 0; font-weight: bold; }
        .btn-next { background: var(--primary); color: #0A0A0C; border: none; padding: 14px 35px; border-radius: 30px; font-weight: 900; font-size: 15px; }
    </style>
</head>
<body>

    <div id="capture-area">
        <div class="header-brand">
            <div class="brand-text">ACE åŒ»ç–—çº§é£é™©æ’æŸ¥</div>
            <div class="step-badge">æ ¸å¿ƒå‡†å…¥æ¡£æ¡ˆ</div>
        </div>
        
        <div class="radar-section">
            <div class="score-board">
                <div class="score-info">
                    <span class="risk-label">èº«ä½“é£é™©çŠ¶æ€è¯„ä¼°</span>
                    <span class="risk-score" id="riskDisplay">å®‰å…¨ (LOW)</span>
                </div>
                <div class="slogan-box" id="sloganBox">å„é¡¹æœºèƒ½è¿è½¬è‰¯å¥½ï¼Œå·²å…·å¤‡é«˜é˜¶è®­ç»ƒå‡†å…¥æ¡ä»¶ã€‚</div>
            </div>
            <div class="radar-container">
                <canvas id="parqRadar"></canvas>
            </div>
        </div>

        <div class="q-list" id="scrollArea">
            <div id="questionContainer"></div>

            <div class="signature-section">
                <div class="sig-header"><span class="sig-title">å®¢æˆ·å…¨å±ç”µå­ç­¾åç¡®è®¤</span></div>
                <div class="sig-result-box" onclick="openSigPad()">
                    <span class="sig-placeholder" id="sigPlaceholder">ğŸ‘‰ ç‚¹å‡»æ­¤å¤„ å…¨å±æ‰‹å†™ç­¾å</span>
                    <img id="sigResultImg" src="">
                </div>
            </div>
        </div>
    </div> 

    <div class="sig-modal" id="sigModal">
        <div class="sig-modal-header">è¯·åœ¨ä¸‹æ–¹ç©ºç™½åŒºåŸŸæ‰‹å†™ç­¾åï¼ˆåŒæ„å®‰å…¨é¡»çŸ¥ï¼‰</div>
        <canvas id="fullscreenSigCanvas"></canvas>
        <div class="sig-modal-footer">
            <button class="modal-btn cancel" onclick="clearSig()">æ¸…é™¤é‡å†™</button>
            <button class="modal-btn confirm" onclick="saveSig()">ç¡®è®¤ç­¾å</button>
        </div>
    </div>

    <div class="bottom-action" id="actionBtnGroup">
        <button class="btn-generate" onclick="generatePoster()">
            <span style="font-size: 20px;">ğŸ›¡ï¸</span> ç”ŸæˆåŒ»ç–—æ’æŸ¥åº•æ¡£å¹¶ä¿å­˜
        </button>
    </div>

    <div class="poster-overlay" id="posterOverlay">
        <div class="poster-scroll-area"><img id="posterImg" class="poster-img" src="" alt="PAR-Q æµ·æŠ¥"></div>
        <div class="poster-tip"><span style="color:var(--primary)">ğŸ‘‡ é•¿æŒ‰ä¸Šæ–¹å›¾ç‰‡ï¼Œä¿å­˜å¸¦ç­¾åçš„å®‰å…¨æ‰¿è¯º</span></div>
        <button class="btn-next" onclick="goToNextStep()">è¿›å…¥ LUXIOU å…¨æ¯æ‰«æ â”</button>
    </div>

    <script>
        const questionData = [
            { title: "ä¸€ã€ å¿ƒè¡€ç®¡ä¸å‘¼å¸ç³»ç»Ÿå¾å…†", qs: [
                { text: "1. åŒ»ç”Ÿæ˜¯å¦æ›¾è¯Šæ–­æ‚¨æ‚£æœ‰å¿ƒè„ç—…ï¼Œæˆ–å»ºè®®åªèƒ½åœ¨åŒ»ç–—ç›‘ç£ä¸‹è¿åŠ¨ï¼Ÿ", impact: { cardio: -40 } },
                { text: "2. åœ¨ä¼‘æ¯ã€æ—¥å¸¸æ´»åŠ¨æˆ–è½»å¾®è¿åŠ¨æ—¶ï¼Œæ‚¨æ˜¯å¦ä¼šæ„Ÿåˆ°èƒ¸ç—›æˆ–èƒ¸é—·ï¼Ÿ", impact: { cardio: -35 } },
                { text: "3. è¿‡å»åŠå¹´å†…ï¼Œæ˜¯å¦æœ‰è¿‡ä¸æ˜åŸå› çš„å¤´æ™•ã€æ™•å¥æˆ–å¤±å»å¹³è¡¡ï¼Ÿ", impact: { cardio: -30, general: -20 } },
                { text: "4. ç›´ç³»äº²å±æ˜¯å¦æœ‰è¿‡å¿ƒè„ç—…å‘ä½œæˆ–çŒæ­»å²ï¼Ÿ", impact: { cardio: -25 } },
                { text: "5. æ‚¨æ˜¯å¦æ‚£æœ‰å“®å–˜ã€æ…¢é˜»è‚ºç­‰å‘¼å¸ç³»ç»Ÿç–¾ç—…ï¼Ÿ", impact: { resp: -35 } },
                { text: "6. ç¨å¾®æ´»åŠ¨ä¸€ä¸‹æ˜¯å¦å°±ä¼šæ„Ÿåˆ°å¼‚å¸¸çš„å‘¼å¸æ€¥ä¿ƒï¼Ÿ", impact: { resp: -30, cardio: -15 } }
            ]},
            { title: "äºŒã€ ä»£è°¢ä¸æ…¢æ€§ç—…å²", qs: [
                { text: "7. æ‚¨æ˜¯å¦æœ‰é«˜è¡€å‹ç—…å²ï¼Œæˆ–ç›®å‰æ­£åœ¨æœç”¨é™å‹è¯ç‰©ï¼Ÿ", impact: { meta: -30, cardio: -20 } },
                { text: "8. æ‚¨æ˜¯å¦æœ‰ç³–å°¿ç—…ï¼Œæˆ–æ›¾è¢«å‘ŠçŸ¥ç©ºè…¹è¡€ç³–åé«˜ï¼Ÿ", impact: { meta: -35 } },
                { text: "9. æ‚¨æ˜¯å¦æ‚£æœ‰ä¸¥é‡é«˜è¡€è„‚ï¼ˆèƒ†å›ºé†‡æŒ‡æ ‡å¼‚å¸¸ï¼‰ï¼Ÿ", impact: { meta: -25 } },
                { text: "10. æ‚¨ç›®å‰æ˜¯å¦å¸çƒŸï¼Œæˆ–æˆ’çƒŸæ—¶é—´ä¸è¶³6ä¸ªæœˆï¼Ÿ", impact: { resp: -20, cardio: -10 } },
                { text: "11. æ‚¨çš„è„šè¸æˆ–å°è…¿æ˜¯å¦ç»å¸¸å‡ºç°ä¸æ˜åŸå› çš„æ°´è‚¿ï¼Ÿ", impact: { meta: -20, cardio: -20 } }
            ]},
            { title: "ä¸‰ã€ éª¨éª¼å…³èŠ‚ä¸å¤–ä¼¤å²", qs: [
                { text: "12. æ‚¨çš„è„ŠæŸ±ã€å…³èŠ‚æˆ–éª¨éª¼æ˜¯å¦æœ‰å·²è¢«åŒ»ç”Ÿç¡®è¯Šçš„æŸä¼¤ï¼Ÿ", impact: { ortho: -40 } },
                { text: "13. æ‚¨çš„å…³èŠ‚æ˜¯å¦æ‚£æœ‰é£æ¹¿æˆ–éª¨å…³èŠ‚ç‚ï¼Ÿ", impact: { ortho: -35 } },
                { text: "14. è¿‘æœŸåŠå¹´å†…æ˜¯å¦æ¥å—è¿‡ä»»ä½•å¤–ç§‘æ‰‹æœ¯å°šåœ¨æ¢å¤æœŸï¼Ÿ", impact: { ortho: -25, general: -30 } }
            ]},
            { title: "å››ã€ ç”Ÿæ´»æ–¹å¼ä¸ç»¼åˆæŒ‡å¾", qs: [
                { text: "15. å¿ƒè„æ˜¯å¦ç»å¸¸å‡ºç°ä¸æ˜åŸå› çš„å‰§çƒˆè·³åŠ¨æˆ–å¿ƒæ‚¸ï¼Ÿ", impact: { cardio: -30 } },
                { text: "16. æ‚¨æ˜¯å¦é•¿æœŸæåº¦ä¹…åï¼ˆæ¯å‘¨è¿åŠ¨å°‘äº3æ¬¡ï¼‰ï¼Ÿ", impact: { general: -15 } },
                { text: "17. æ˜¯å¦è¢«åŒ»ç”Ÿå‘ŠçŸ¥è¿‡å­˜åœ¨ä¸¥é‡çš„è‚¥èƒ–ç›¸å…³é£é™©ï¼Ÿ", impact: { meta: -25, ortho: -15 } },
                { text: "18. æ˜¯å¦æœ‰å…¶ä»–ä»»ä½•ç–¾ç—…ï¼ŒåŒ»ç”Ÿå»ºè®®æ‚¨è¿åŠ¨å‰å¿…é¡»å’¨è¯¢ä¸“ä¸šæ„è§ï¼Ÿ", impact: { general: -40 } }
            ]}
        ];

        const container = document.getElementById('questionContainer');
        questionData.forEach(group => {
            let html = `<div class="cat-title">${group.title}</div>`;
            group.qs.forEach(q => {
                let impactStr = JSON.stringify(q.impact);
                html += `
                    <div class="q-item">
                        <div class="q-text">${q.text}</div>
                        <div class="ans-group">
                            <div class="ans-btn yes" data-impact='${impactStr}' onclick="selectAns(this, true)">æ˜¯çš„ (YES)</div>
                            <div class="ans-btn no active" onclick="selectAns(this, false)">æ²¡æœ‰ (NO)</div>
                        </div>
                    </div>`;
            });
            container.innerHTML += html;
        });

        const canvas = document.getElementById('parqRadar');
        const ctx = canvas.getContext('2d');
        const labels = ["å¿ƒè¡€ç®¡ç³»ç»Ÿ", "éª¨éª¼ä¸å…³èŠ‚", "ä»£è°¢çŠ¶æ€", "å‘¼å¸ç³»ç»Ÿ", "ç»¼åˆæŒ‡å¾"];
        const maxScore = 100;
        let curScores = { cardio: 100, ortho: 100, meta: 100, resp: 100, general: 100 };
        let tgtScores = { cardio: 100, ortho: 100, meta: 100, resp: 100, general: 100 };

        function drawRadar() {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            const w = rect.width, h = rect.height;
            const centerX = w / 2; const centerY = h / 2 + 5;
            const radius = Math.min(w, h) / 2 * 0.75; const sides = 5;

            ctx.clearRect(0, 0, w, h);
            ctx.lineWidth = 1;
            for (let level = 1; level <= 4; level++) {
                ctx.beginPath();
                for (let i = 0; i < sides; i++) {
                    let angle = (Math.PI * 2 * i) / sides - Math.PI / 2;
                    let x = centerX + radius * (level / 4) * Math.cos(angle);
                    let y = centerY + radius * (level / 4) * Math.sin(angle);
                    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.strokeStyle = `rgba(226, 192, 124, ${0.08 * level})`; ctx.stroke();
            }

            ctx.fillStyle = "#8A92A3"; ctx.font = "bold 11px sans-serif"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            for (let i = 0; i < sides; i++) {
                let angle = (Math.PI * 2 * i) / sides - Math.PI / 2;
                let x = centerX + radius * Math.cos(angle); let y = centerY + radius * Math.sin(angle);
                ctx.beginPath(); ctx.moveTo(centerX, centerY); ctx.lineTo(x, y);
                ctx.strokeStyle = "rgba(255,255,255,0.03)"; ctx.stroke();
                let labelX = centerX + (radius + 28) * Math.cos(angle); let labelY = centerY + (radius + 15) * Math.sin(angle);
                ctx.fillText(labels[i], labelX, labelY);
            }

            ctx.beginPath();
            const keys = ['cardio', 'ortho', 'meta', 'resp', 'general'];
            keys.forEach((key, i) => {
                let angle = (Math.PI * 2 * i) / sides - Math.PI / 2;
                let val = Math.max(10, curScores[key]);
                let x = centerX + radius * (val / maxScore) * Math.cos(angle); let y = centerY + radius * (val / maxScore) * Math.sin(angle);
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            });
            ctx.closePath();
            
            let hasRisk = Object.values(curScores).some(s => s < 90);
            let gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, radius);
            if(hasRisk) { 
                gradient.addColorStop(0, "rgba(217, 83, 79, 0.5)"); gradient.addColorStop(1, "rgba(217, 83, 79, 0.05)");
                ctx.fillStyle = gradient; ctx.strokeStyle = "#D9534F"; ctx.shadowColor = "rgba(217, 83, 79, 0.4)"; 
            } else { 
                gradient.addColorStop(0, "rgba(226, 192, 124, 0.5)"); gradient.addColorStop(1, "rgba(226, 192, 124, 0.05)");
                ctx.fillStyle = gradient; ctx.strokeStyle = "#E2C07C"; ctx.shadowColor = "rgba(226, 192, 124, 0.4)"; 
            }
            ctx.shadowBlur = 15; ctx.lineWidth = 2; ctx.fill(); ctx.stroke(); ctx.shadowBlur = 0; 
        }

        function animate() {
            let needsUpdate = false;
            const keys = ['cardio', 'ortho', 'meta', 'resp', 'general'];
            keys.forEach(key => {
                let diff = tgtScores[key] - curScores[key];
                if (Math.abs(diff) > 0.5) { curScores[key] += diff * 0.2; needsUpdate = true; }
            });
            if (needsUpdate) { drawRadar(); updateRiskLabel(); }
            requestAnimationFrame(animate);
        }

        function updateRiskLabel() {
            let curSum = Object.values(curScores).reduce((a,b)=>a+b, 0);
            let totalDeduction = Math.round(500 - curSum); 
            
            let display = document.getElementById('riskDisplay');
            let slogan = document.getElementById('sloganBox');
            
            if(totalDeduction <= 0) { 
                display.innerText = "å®‰å…¨ (LOW)"; display.className = "risk-score"; display.style.color = "var(--primary)";
                slogan.className = "slogan-box"; slogan.innerText = "å„é¡¹æœºèƒ½è¿è½¬è‰¯å¥½ï¼Œå·²å…·å¤‡é«˜é˜¶è®­ç»ƒå‡†å…¥æ¡ä»¶ã€‚";
            } else if(totalDeduction < 60) { 
                display.innerText = "å…³æ³¨ (MOD)"; display.className = "risk-score high"; display.style.color = "var(--accent)"; 
                slogan.className = "slogan-box warn"; slogan.innerText = "å­˜åœ¨æ½œåœ¨å¥åº·çŸ­æ¿ï¼Œå»ºè®®ç«‹åˆ»å¼€å±•å®šåˆ¶åŒ–æ¢å¤è®­ç»ƒã€‚";
            } else { 
                display.innerText = "å±é™© (HIGH)"; display.className = "risk-score high"; display.style.color = "var(--danger)"; 
                slogan.className = "slogan-box crit"; slogan.innerText = "å¥åº·é£é™©å·²è¶…ä¸´ç•Œå€¼ï¼äºŸéœ€ä¸“ä¸šåŒ»ç–—ä¸åº·å¤çº§å¹²é¢„ï¼";
            }
        }

        function selectAns(btn, isYes) {
            let siblings = btn.parentElement.children;
            for(let i=0; i<siblings.length; i++) siblings[i].classList.remove('active');
            btn.classList.add('active');
            recalcParqScores();
        }

        function recalcParqScores() {
            let newS = { cardio: 100, ortho: 100, meta: 100, resp: 100, general: 100 };
            document.querySelectorAll('.ans-btn.yes.active').forEach(btn => {
                let impact = JSON.parse(btn.getAttribute('data-impact'));
                for(let key in impact) { newS[key] += impact[key]; }
            });
            tgtScores = newS;
        }

        // ğŸš€ å…¨å±ç­¾å­—ç‰ˆé€»è¾‘
        const fSigCanvas = document.getElementById('fullscreenSigCanvas');
        const fSigCtx = fSigCanvas.getContext('2d');
        let fIsDrawing = false;

        function openSigPad() {
            let modal = document.getElementById('sigModal');
            modal.style.display = 'flex'; // å¼ºåˆ¶å…¨å±æ˜¾ç¤º
            
            // è·å–å…¨å±å°ºå¯¸åˆå§‹åŒ– Canvas
            const dpr = window.devicePixelRatio || 1;
            fSigCanvas.width = fSigCanvas.clientWidth * dpr; 
            fSigCanvas.height = fSigCanvas.clientHeight * dpr;
            fSigCtx.scale(dpr, dpr); 
            fSigCtx.lineWidth = 4; // åŠ ç²—æ›´æœ‰æ°”åœº
            fSigCtx.lineCap = 'round'; 
            fSigCtx.strokeStyle = '#E2C07C'; // é“‚é‡‘å¢¨æ°´
            fSigCtx.clearRect(0, 0, fSigCanvas.width, fSigCanvas.height);
        }

        function getFPos(e) {
            const rect = fSigCanvas.getBoundingClientRect();
            const x = e.touches ? e.touches[0].clientX : e.clientX;
            const y = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: x - rect.left, y: y - rect.top };
        }

        fSigCanvas.addEventListener('mousedown', e => { fIsDrawing = true; const p = getFPos(e); fSigCtx.beginPath(); fSigCtx.moveTo(p.x, p.y); });
        fSigCanvas.addEventListener('mousemove', e => { if(fIsDrawing){ const p = getFPos(e); fSigCtx.lineTo(p.x, p.y); fSigCtx.stroke(); }});
        fSigCanvas.addEventListener('mouseup', () => fIsDrawing = false); 
        fSigCanvas.addEventListener('mouseout', () => fIsDrawing = false);

        fSigCanvas.addEventListener('touchstart', e => { e.preventDefault(); fIsDrawing = true; const p = getFPos(e); fSigCtx.beginPath(); fSigCtx.moveTo(p.x, p.y); }, {passive: false});
        fSigCanvas.addEventListener('touchmove', e => { e.preventDefault(); if(fIsDrawing){ const p = getFPos(e); fSigCtx.lineTo(p.x, p.y); fSigCtx.stroke(); }}, {passive: false});
        fSigCanvas.addEventListener('touchend', () => fIsDrawing = false);

        function clearSig() { 
            fSigCtx.clearRect(0, 0, fSigCanvas.width, fSigCanvas.height); 
        }

        function saveSig() {
            // å°†å…¨å±ç”»å¸ƒä¿å­˜ä¸ºå›¾ç‰‡æ”¾å›ä¸»å±å¹•
            let dataUrl = fSigCanvas.toDataURL("image/png");
            document.getElementById('sigResultImg').src = dataUrl;
            document.getElementById('sigResultImg').style.display = 'block';
            document.getElementById('sigPlaceholder').style.display = 'none';
            document.getElementById('sigModal').style.display = 'none';
        }

        function generatePoster() {
            if(document.getElementById('sigPlaceholder').style.display !== 'none') {
                alert("è¯·ç‚¹å‡»åº•éƒ¨ã€å®Œæˆå…¨å±ç”µå­ç­¾åã€‘åå†ç”Ÿæˆå…è´£åº•æ¡£ï¼"); return;
            }

            if (navigator.vibrate) navigator.vibrate(50);
            let btn = document.querySelector('.btn-generate');
            btn.innerHTML = "â³ æ­£åœ¨ç”Ÿæˆå¸¦ç­¾åçš„åŒ»ç–—åº•æ¡£..."; btn.style.opacity = "0.7"; document.getElementById('actionBtnGroup').style.display = 'none';
            
            let captureArea = document.getElementById('capture-area'); let scrollArea = document.getElementById('scrollArea');
            let origHeight = captureArea.style.height; let origOverflow = scrollArea.style.overflowY; let origFlex = scrollArea.style.flex;
            
            scrollArea.style.overflowY = 'visible'; scrollArea.style.flex = 'none'; captureArea.style.height = captureArea.scrollHeight + 'px';

            html2canvas(captureArea, { backgroundColor: "#0A0A0C", scale: 2, windowHeight: captureArea.scrollHeight }).then(canvas => {
                captureArea.style.height = origHeight; scrollArea.style.overflowY = origOverflow; scrollArea.style.flex = origFlex;
                document.getElementById('actionBtnGroup').style.display = 'block'; btn.innerHTML = "<span style='font-size: 20px;'>ğŸ›¡ï¸</span> ç”ŸæˆåŒ»ç–—æ’æŸ¥åº•æ¡£å¹¶ä¿å­˜"; btn.style.opacity = "1";
                document.getElementById('posterImg').src = canvas.toDataURL("image/jpeg", 0.9);
                document.getElementById('posterOverlay').style.display = 'flex';
            }).catch(err => {
                alert("ç”Ÿæˆæ¡£æ¡ˆå¤±è´¥ï¼Œè¯·é‡è¯•ï¼"); document.getElementById('actionBtnGroup').style.display = 'block';
                captureArea.style.height = origHeight; scrollArea.style.overflowY = origOverflow; scrollArea.style.flex = origFlex;
            });
        }

        function goToNextStep() { window.location.href = 'case_detail.html'; }
        window.onload = () => { drawRadar(); animate(); window.addEventListener('resize', drawRadar); };
    </script>
</body>
</html>
